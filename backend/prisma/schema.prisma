// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Utilise le système d'auth de Supabase
model User {
  id        String   @id // UUID de Supabase auth.users
  email     String   @unique
  firstName String?
  lastName  String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  watchlist       WatchlistItem[]
  watchedSeries   WatchedSerie[]
  watchlistMovies WatchlistMovie[]
  watchedMovies   WatchedMovie[]
  ratings         Rating[]
  preferences     UserPreferences?

  @@map("users")
}

model UserPreferences {
  id               String @id @default(cuid())
  userId           String @unique
  
  // Général
  language         String @default("fr-FR")      // Langue de l'interface (ex: fr-FR, en-US)
  country          String @default("FR")          // Région du contenu (ex: FR, US, JP)
  includeAdult     Boolean @default(false)        // Contenu pour adultes
  
  // Contenu
  favoriteGenres   Int[]  @default([])            // Genres préférés (IDs TMDB)
  dislikedGenres   Int[]  @default([])            // Genres à éviter (IDs TMDB)
  favoriteActors   Int[]  @default([])            // Acteurs préférés (IDs TMDB)
  minRating        Float  @default(0)             // Note minimum
  maxRating        Float  @default(10)            // Note maximum
  releaseYearFrom  Int?                           // Année de sortie depuis
  releaseYearTo    Int?                           // Année de sortie jusqu'à
  
  // Affichage
  theme            String @default("auto")        // Thème: light, dark, auto
  defaultView      String @default("grid")        // Vue: grid, list
  itemsPerPage     Int    @default(20)            // Éléments par page
  autoplay         Boolean @default(true)         // Lecture auto des trailers
  showSpoilers     Boolean @default(false)        // Afficher les spoilers
  
  // Notifications (stockées en JSON)
  notifications    Json   @default("{\"newReleases\":true,\"recommendations\":true,\"watchlistUpdates\":true}")
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model WatchlistItem {
  id        String   @id @default(cuid())
  userId    String
  serieId   Int      // TMDB ID
  serieName String
  serieData Json     // Store complete TMDB serie data
  addedAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, serieId])
  @@map("watchlist_items")
}

model WatchedSerie {
  id          String   @id @default(cuid())
  userId      String
  serieId     Int      // TMDB ID
  serieName   String
  serieData   Json     // Store complete TMDB serie data
  watchedAt   DateTime @default(now())
  seasonsWatched Int[] @default([]) // Array of season numbers watched
  episodesWatched Json @default("{}") // JSON object with season -> episodes mapping
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, serieId])
  @@map("watched_series")
}

model WatchlistMovie {
  id        String   @id @default(cuid())
  userId    String
  movieId   Int      // TMDB ID
  movieName String
  movieData Json     // Store complete TMDB movie data
  addedAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId])
  @@map("watchlist_movies")
}

model WatchedMovie {
  id          String   @id @default(cuid())
  userId      String
  movieId     Int      // TMDB ID
  movieName   String
  movieData   Json     // Store complete TMDB movie data
  watchedAt   DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId])
  @@map("watched_movies")
}

model Rating {
  id        String   @id @default(cuid())
  userId    String
  serieId   Int      // TMDB ID
  rating    Float    // 0.5 to 10
  review    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, serieId])
  @@map("ratings")
}
